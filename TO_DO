GENERAL:

1. ATB added comments in various places in rot3d.c, pycresta.py, tom.py related to the various angle conventions and conversions. 
Please read and and suggest more explanations if needed. The code is extremely convoluted and the angle conventions are quite confusing.

------------------------------------------------------------------------
 
DONE:

1. Plot Back: ATB fixed inverse Euler angle issue in Plot Back (briefly, reverse engineered what was done for masking,
call to eulerconvert_xmipp, swap angles indices 0 and 1).  ATB also incorporated small shifts from star file and
added an info message after each plot back subtomogram has been written. I added comments in cresta.py and tom.py.


2. Modify: ATB fixed issue: manual (x,y,z) rottrans produces sometimes bus error when operating on previously rotated volumes:

- the issue is this statement in def processParticler in tom.py
   outH1 = cut_out(outH1, np.array([0, 0, 0]), boxsize)   
   I commented it out - it is only used in that place. It makes the box smaller if there are values < 1? This does not make much sense!  
   it produces a box that is 255,255,255 rather than 256,256,256. This mismatch causes issues with subsequent rotate commands.
 - another issue is the interpolation exception treatment in rot3d.c. I reverted back to the original code, but included additional cushion:
 - finally, I calculate the mean of the image density and use that for the pixels outside the range, except for masks where the value is set to zero.
  - I added comments in rot3d.c.
 
------------------------------------------------------------------------


TODO:

1. Filtering: Each time pycresta creates a new directory with subtomograms, please write all information about settings and inputs as a text 
file into that directory, i.e., project text file. So, if the user performs filtering, the file should contain the information about
the particular settings and inputs that were used for the filtering job. -->> OK, but please also do for Gaussian.

2. Extraction: Incorporate calc angles directly into Extraction as an option. Ask user to specify the file extensions for the 
start and end point coordinates rather than full path names.  

3.Extraction: Introduce batch mode for Extraction with multiple tomograms in one directory.

4. Plot Back:
   - parallelize the process 
   - test if it works if the star file refers to multiple tomograms.

5. Extraction: write info about star file, and populate Master Key at end of Extraction/Calculate Angles

6. Masking: populate Master Key at end of Masking

7. Modify: write info about star file and populate Master key at end of Modify -> Rotate... and -> Rotate Manually.

9. Modify: Set zero angles in new star file after star file or manual rotations.

10. Extraction: assumes the coords file is an integer with a single space between coordinate points (i.e. "int1 int2 int3"). 
This isn't the default output of IMOD model2point - at least my version - which defaults to float and 
tab separated values ("    float1    float2    float3"). Comma separated values also fail for the same reason since the string cannot be converted to int. 
-> Auto-detect format: convert floats to an integer, and handle separators other than single spaces (any number of spaces or other delimiters).

11. Several: Please add a test to ensure that the box dimensions and pixel sizes match in Master Key match those of the 
subtomogram in the rotation tasks, masking, correlation calc. (e.g., prior to calling the rot3d.c function). pixel 
size mismatch should be warning only. Box dimension mismatch should stop program. Look for "ATB todo" in 
cresta.py and tom.py. But, there may be other places as well.

12. Related to this, when using Masking with the standard mask file, I get this error message:

Center, boxsize, filter, grow, normalizeit, sdrange, sdshift,blackdust,whitedust,shiftfil,randfilt,permutebg)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   File "/Users/brunger/GitHub/pycresta/tom.py", line 296, in processParticle
     outH1 = maskWithFil(outH1,maskh1Trans, sdRange, sdShift,blackdust,whitedust)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   File "/Users/brunger/GitHub/pycresta/tom.py", line 613, in maskWithFil
     ind_mean = np.mean(input[indd])
                        ~~~~~^^^^^^
 IndexError: index 16515072 is out of bounds for axis 0 with size 16515072


13. Masking, Modify, and Plot Back: test that shifts from Star file are properly applied.

14. Extraction: check what happens when extraction is done close border of tomogram? 

15. Plot back mrc files 14, 15, 16, 22-38  in 201810XX_MPI/SV4_003_dff/sub are all mapped to the same position in Chimera/ChimeraX, although
the header indicates different positions!  What does Chimera/ChimeraX use to position the map?

axelmacbook2023:plotback brunger$ header SV4_003_dff000028.mrc 

 RO image file on unit   1 : SV4_003_dff000028.mrc     Size=      65537 K

 Number of columns, rows, sections .....     256     256     256
 Map mode ..............................    2   (32-bit real)              
 Start cols, rows, sects, grid x,y,z ...  776   304  2592     256    256    256
 Pixel spacing (Angstroms)..............   2.620      2.620      2.620    
 Cell angles ...........................   90.000   90.000   90.000
 Fast, medium, slow axes ...............    X    Y    Z
 Origin on x,y,z .......................    0.000       0.000       0.000    
 Minimum density ....................... -0.95041E-01
 Maximum density .......................  0.11996    
 Mean density ..........................  0.78921E-04
 RMS deviation from mean................  0.30134E-02
 tilt angles (original,current) ........   0.0   0.0   0.0   0.0   0.0   0.0
 Space group,# extra bytes,idtype,lens .        1        0        0        

     1 Titles :
Created by mrcfile.py                                       2023-08-11 11:48:00


xelmacbook2023:plotback brunger$ header SV4_003_dff000027.mrc 

 RO image file on unit   1 : SV4_003_dff000027.mrc     Size=      65537 K

 Number of columns, rows, sections .....     256     256     256
 Map mode ..............................    2   (32-bit real)              
 Start cols, rows, sects, grid x,y,z ... 1980   520  3460     256    256    256
 Pixel spacing (Angstroms)..............   2.620      2.620      2.620    
 Cell angles ...........................   90.000   90.000   90.000
 Fast, medium, slow axes ...............    X    Y    Z
 Origin on x,y,z .......................    0.000       0.000       0.000    
 Minimum density ....................... -0.96127E-01
 Maximum density .......................  0.12102    
 Mean density ..........................  0.73082E-04
 RMS deviation from mean................  0.30137E-02
 tilt angles (original,current) ........   0.0   0.0   0.0   0.0   0.0   0.0
 Space group,# extra bytes,idtype,lens .        1        0        0        0

     1 Titles :
Created by mrcfile.py                                       2023-08-11 11:47:59



-------------------------------------------------------------------------


OTHER:

1. Try Chimerax plugin ArtiaX, https://pubmed.ncbi.nlm.nih.gov/36251681/, https://onlinelibrary.wiley.com/doi/10.1002/pro.4472  Any comments?

2. Add the box size and pixel size as a comment into the cmm files? For future.

3. Memory mapping for Filtering? Not possible.



